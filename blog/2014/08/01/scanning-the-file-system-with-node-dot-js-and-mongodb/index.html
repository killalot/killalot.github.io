<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Scanning the file system with Node.js and MongoDB</title>
  <meta name="description" content="At some point you may come across a situation where you would like to scan a file system / file directory or multiple storage locations. This might for a var...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.ticnfae.co.uk/blog/2014/08/01/scanning-the-file-system-with-node-dot-js-and-mongodb/">
  <link rel="alternate" type="application/rss+xml" title="Ticnfae" href="http://www.ticnfae.co.uk/feed.xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26245170-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
      <div class="site-title">
          <a href="/">Ticnfae</a>
          <small>Things. I. Could. Not. Find. Anywhere. Else.</small>
      </div>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Scanning the file system with Node.js and MongoDB</h1>
    <p class="post-meta"><time datetime="2014-08-01T11:32:20+01:00" itemprop="datePublished">Aug 1, 2014</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="prerequisites">Prerequisites</h2>
<ul>
  <li>Node.js installed</li>
  <li>MongoDB installed</li>
  <li>Basic knowledge of how to use both</li>
</ul>

<p>At some point you may come across a situation where you would like to scan a file system / file directory or multiple storage locations. This might for a variety of reasons such as:</p>

<ul>
  <li>Which directory holds the most files</li>
  <li>Do you have any duplicated files</li>
  <li>Which directory contains the most data</li>
</ul>

<p>Now there are plenty of methods of obtaining this information from using freeware or paid-for GUI applications to small command line scripts. However some programs do not store their results - they will present you with the information you need but if you want to analyse the results later youâ€™ll have to run the program again. This problem is also amplified if you want to analyse results from different media sources. For instance, drives on different machines that are not connected to each other.</p>

<p>As an experiment I decided to I see how I could utilise Node.js event based programming to scan through a file system and then use MongoDB to store the data which can then be looked at later or added to.</p>

<p>The code is contained in a single Javascript file run through Node.js on the command line:</p>
<pre><code class="language-Javascript">// options
var openFiles = 0; // counting number of currently opened files
var directoriesToScan = []; // used to hold the list of directory paths that has yet to be scanned
var maxOpenFiles = 300; // The max number of files that can be opened at once. Any higher on my machine seemed to make no real speed difference but feel free to experiment
var waitTime = 20; // defines the sleep time to wait for reading files when 'openFiles' has reached the maximum value
var startingDirectory = "/home/peter/"; // root directory to start indexing from - this can be just '/' but always end in a slash

var fs = require('fs'); // for accessing file system
var crypto = require('crypto'); // for hashing file contents
// libaries for access mongodb - copied from mongoDB Node.js drive tutorial
var Db = require('mongodb').Db,
    MongoClient = require('mongodb').MongoClient,
    Server = require('mongodb').Server,
    ReplSetServers = require('mongodb').ReplSetServers,
    ObjectID = require('mongodb').ObjectID,
    Binary = require('mongodb').Binary,
    GridStore = require('mongodb').GridStore,
    Grid = require('mongodb').Grid,
    Code = require('mongodb').Code,
    BSON = require('mongodb').pure().BSON;
// don't forget to create a 'file_duplicates' database in your mongo server
var db = new Db('file_duplicates', new Server('localhost', 27017,{auto_reconnect: true}),{w:1});
// Connect to the db
db.open(function(err,db){

	var scanDirectory = function(dir){
		if(openFiles&gt;maxOpenFiles){
			// wait a bit if the maximum number of files is open.
			setTimeout(function(){scanDirectory(dir);}, waitTime);
		}else{
			// gather files and directories inside directory currently being scanned
			var files = fs.readdirSync(dir);			
				files.forEach(function(file){
					// get stats about file to check if its a directory and to get file size								
					var stat = fs.lstatSync(dir + file);
					if(stat.isFile()){
						if(openFiles &gt; maxOpenFiles){
							setTimeout(function(){readFile(dir,file,stat.size)}, waitTime);
						}else{
							readFile(dir,file,stat.size);
						}

					}else if(stat.isDirectory()){
						// if is a directory add to list of directories to scan.
						directoriesToScan.push(dir + file + '/');
					}
				});
			if(directoriesToScan.length &gt; 0 ){
				if(openFiles &gt; maxOpenFiles){
					setTimeout(function(){scanDirectory(directoriesToScan.pop());}, waitTime);
				}else{
					scanDirectory(directoriesToScan.pop());
				}
			}
		}
	};

	var readFile = function(dir,file,size){
		//console.log(openFiles + " readFile");
		if(openFiles &gt; maxOpenFiles){
			setTimeout(function(){readFile(dir,file,size)}, waitTime);
		}else{
			openFiles++;
			// setup file stream and hash
			var fd = fs.createReadStream(dir + file);
			var hash = crypto.createHash('md5');
			hash.setEncoding('hex');

			fd.on('end', function(){
			    hash.end();
			    openFiles--;
			    // when finished reading file insert file details into collection (make sure to create the collection first)
			    db.collection('files', function(err, collection) {
					collection.insert({fileName:file,path:dir+file,hash:hash.read(),size:size},function(err, result){
						if(err) throw err;
						if(openFiles == 0 &amp;&amp; directoriesToScan == 0) db.close();
					});			
				});
			});

			fd.on('error',function(err){
				openFiles--;
				console.log("stream error " + err);
			});

			// read all file and pipe it (write it) to the hash object
			fd.pipe(hash);


		}
	};

	// start the scanning
	scanDirectory(startingDirectory);
});
</code></pre>

<h2 id="further-reading">Further reading</h2>
<ul>
  <li><a href="http://docs.mongodb.org/ecosystem/drivers/node-js/">Node.js MongoDB Driver</a></li>
  <li><a href="http://nodejs.org/api/fs.html">Node.js File System Module</a></li>
</ul>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Ticnfae</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>peter.nicholson1991 at gmail.com</li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/pnicholson"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">pnicholson</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Things. I. Could. Not. Find. Anywhere. Else.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
