<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Refactoring Spring @ModelAttribute Method With Java 8</title>
  <meta name="description" content="ModelAttribute methods in Spring controllers that obtain database data using path variables can be ugly in Spring 3/4. In this post I demonstrate how to make...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://www.ticnfae.co.uk/blog/2016/06/30/refactoring-modelattribute-with-java-8/">
  <link rel="alternate" type="application/rss+xml" title="Ticnfae" href="http://www.ticnfae.co.uk/feed.xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26245170-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
      <div class="site-title">
          <a href="/">Ticnfae</a>
          <small>Things. I. Could. Not. Find. Anywhere. Else.</small>
      </div>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Refactoring Spring @ModelAttribute Method With Java 8</h1>
    <p class="post-meta"><time datetime="2016-06-30T06:34:46+01:00" itemprop="datePublished">Jun 30, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>

<p>In Spring MVC you can annotate a public method in a controller with <code class="highlighter-rouge">@ModelAttribute</code>. By doing so the method is run before any <code class="highlighter-rouge">@RequestMapping</code> method (how Spring controllers deal with requests) is run. Methods annotated as such are used to set one or more model attributes that can be later used in the controller itself or in a template engine such as JSP. In this post I would like to show how you can refactor a ModelAttribute method to take advantage of Spring 4’s support of Java 8 Optionals which coupled with lambdas can provide you with a concise and readable solution.</p>

<h2 id="the-staff-member-example">The Staff Member Example</h2>

<p>As an example to help us along, consider a HR application. In this application as you might expect is a requirement to insert and edit Staff member records. Part of the implementation for this is the spring controller which responds to the following paths:</p>

<ul>
  <li><code class="highlighter-rouge">/staff</code> GET (list of staff)</li>
  <li><code class="highlighter-rouge">/staff/{id}/edit</code> GET (edit staff member form)</li>
  <li><code class="highlighter-rouge">/staff/{id}</code> POST (update staff member)</li>
  <li><code class="highlighter-rouge">/staff/{id}</code> DELETE (delete staff member)</li>
  <li><code class="highlighter-rouge">/staff</code> POST (create staff member)</li>
  <li><code class="highlighter-rouge">/staff/new</code> GET (new staff member form)</li>
</ul>

<p><code class="highlighter-rouge"><span class="p">{</span><span class="err">id</span><span class="p">}</span></code> is the staff members unique identifier in the database. Data is submitted to the controller via a typical HTML form - we won’t consider AJAX here. To narrow down the possible solutions some more I will say that the form does not contain all inputs for the staff member entity. A session attribute <code class="highlighter-rouge">username</code> is needed to be set to a new staff member instance for it to be valid.</p>

<h2 id="implementation-prior-to-java-8">Implementation Prior To Java 8</h2>

<p>A primary part of the spring controller is the ModelAttribute method. Lets look at how this could be written prior to Java 8.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">"staffMember"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">StaffMember</span> <span class="nf">loadStaff</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pathVariables</span><span class="o">,</span> <span class="n">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StaffMember</span> <span class="n">staffMember</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">pathVariables</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">pathVariables</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
        <span class="n">staffMember</span> <span class="o">=</span> <span class="n">staffMemberDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">staffMember</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StaffMember</span><span class="o">();</span>
        <span class="n">staffMember</span><span class="o">.</span><span class="na">setCreatedBy</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">staffMember</span><span class="o">;</span>        
<span class="o">}</span>
</code></pre>
</div>

<p>Here you can see two distinct paths of the method. The annotated <code class="highlighter-rouge">pathVariables</code> parameter is being used as a means to check what action the user is performing inside the controller. If the <code class="highlighter-rouge">id</code> path variable exists then the user has either submitted a update form or visited the edit page. So in this situation we need to obtain the existing staff member from the database. When the <code class="highlighter-rouge">id</code> path variable isn’t present then we know the user has visited the new form or index page or submitted a create form. In this case we create a new instance of the <code class="highlighter-rouge">StaffMember</code> object and set the <code class="highlighter-rouge">createdBy</code> field to the value present in the session (we will assume the session attribute is guaranteed to be there).</p>

<h2 id="refactoring-the-method-to-use-java-8">Refactoring The Method To Use Java 8</h2>

<p>With Spring 4.1 and above now supporting <code class="highlighter-rouge">Optional&lt;T&gt;</code> parameters annotated by <code class="highlighter-rouge">@PathVariable</code> , we can rewrite the above code like so:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@ModelAttribute</span><span class="o">(</span><span class="s">"staffMember"</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">StaffMember</span> <span class="nf">loadStaff</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">idOpt</span><span class="o">,</span> <span class="n">HttpSession</span> <span class="n">httpSession</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">idOpt</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="n">staffMemberDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
            <span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">StaffMember</span> <span class="n">staffMember</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StaffMember</span><span class="o">();</span>
                <span class="n">staffMember</span><span class="o">.</span><span class="na">setCreatedBy</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
                <span class="k">return</span> <span class="n">staffMember</span><span class="o">;</span>
            <span class="o">});</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The first difference you’ll be able to see is that we are no longer obtaining all the available path variables. Since Spring does not allow you to have a path variable parameter that is null (Spring will throw an exception), we had to bring in a Map of the path variables and check if <code class="highlighter-rouge">id</code> was present. In Spring 4.1+ we can now wrap our sometimes null path variable with the Optional class. This is explicitly stating that the path variable could be missing, providing better readability.</p>

<p>With access to an Optional instance, we can make use of its available methods. The lambda inside the map method is run only when the <code class="highlighter-rouge">id</code> path variable is present. You can think of it as a replacement of the if block in the previous code. The else block functionality has been replaced by the <code class="highlighter-rouge">orElseGet</code> method. This takes a <code class="highlighter-rouge">Supplier&lt;T&gt;</code> function and runs when <code class="highlighter-rouge">ipOpt</code> is empty, in other words when the <code class="highlighter-rouge">id</code> variable is not present in the path.</p>

<h2 id="summary">Summary</h2>

<p>You can see how the second code example is less verbose than the first and is also easier to read. We have hidden the null check of the path variable and casting it to a Long which is now performed internally.</p>

<p>Hopefully this refactoring example has given you a glimpse of what is now possible using Java 8 and Spring 4.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Ticnfae</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>peter.nicholson1991 at gmail.com</li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/pnicholson"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">pnicholson</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Things. I. Could. Not. Find. Anywhere. Else.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
